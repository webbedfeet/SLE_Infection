---
title: "Results"
output:
  word_document: default
  html_notebook: default
  html_document: default
---

```{r, echo=F}
knitr::opts_chunk$set(echo=FALSE)
```

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
source('lib/reload.R'); reload()
load(file.path(datadir, 'data','rda','data.rda'))
```

# Methods

We are interested in discovering if the death risk in individuals admitted with sepsis differs between SLE and non-SLE patients within hospitals. In other words, do SLE patients admitted with sepsis experience excess deaths compared to non-SLE patients, within hospitals. 

We take a counterfactual approach to this problem. We propose to model the risk of death among the non-SLE patients conditional on various covariates including the admission hospital, age, comorbidities, admission on ventilator, gender, and type of insurance. We would then use this model to predict the risk (or probability) of death during hospitalization for each SLE patient using the observed covariates for that patient. This would give the risk of death for that patient under the assumption that they had the same conditional death risk as non-SLE patients. If we add up these predicted probabilities over patients in a hospital, we would get the _expected_ number of deaths (E) among SLE patients under the assumption that they shared the same experience as non-SLE patients. We would compare this with the _observed_ number of deaths (O) among SLE patients at that hospital. The O/E ratio is akin to a standardized mortality rate, where the standardized population would be non-SLE patients with sepsis in the sample. 

In order to flexibly model the conditional risk of death, we use the XGBoost algorithm (Chen, et al, 2016)[^1]. This modern form of gradient boosted trees allows for regularization as well as stochastic
gradient descent methods to reduce the chance of overfitting, and utilizes decision trees as the 
learning engine to allow flexible prediction of the outome from heterogeneous responses. For training
the XGBoost model,we use the R package xgboost [^2], running on R[^3] version 3.4. We 
train this model on the non-SLE patients,  using 5-fold cross-validation to train the 
model parameters (using the R package caret[^4]). Our optimal trained model achieved a cross-validated average AUC of 0.86. We then use this trained model to predict the risk of death among SLE patients,
by scoring each patient using the model to get a predicted probability of death. Within hospital, 
we then add these predicted probabilities to obtain the expected number of deaths under the assumption
that the risk for SLE and non-SLE patients are the same. Finally, we compare the observed 
number of deaths per hospital with the expected number of deaths under the model. Note that the
expected conditional probabilities of death use information across all hospitals and patients through the XGBoost model. Also note that, despite the hospitals being sampled from the national 
population of hospitals under the NIS, our analysis is conditional on the hospitals and patients
in our dataset and so we do not use the sampling weights provided by NIS in our modeling. 

All analyses were performed using R[^3] version 3.4 along with the packages xgboost[^2], 
caret[^3] and survey[^5].

[^2]:Tianqi Chen, Tong He, Michael Benesty, Vadim Khotilovich and Yuan
  Tang (2017). xgboost: Extreme Gradient Boosting. R package version
  0.6-4. https://CRAN.R-project.org/package=xgboost
[^3]: R Core Team (2017). R: A language and environment for statistical
  computing. R Foundation for Statistical Computing, Vienna, Austria.
  URL https://www.R-project.org/.
[^4]: Max Kuhn. Contributions from Jed Wing, Steve Weston, Andre
  Williams, Chris Keefer, Allan Engelhardt, Tony Cooper, Zachary
  Mayer, Brenton Kenkel, the R Core Team, Michael Benesty, Reynald
  Lescarbeau, Andrew Ziem, Luca Scrucca, Yuan Tang, Can Candan and
  Tyler Hunt. (2017). caret: Classification and Regression Training.
  R package version 6.0-77. https://CRAN.R-project.org/package=caret
[^5]: T. Lumley (2017) "survey: analysis of complex survey samples". R
  package version 3.32.

# Results

Table 1 gives the sampling weight adjusted summary statistics for various measurements
utilized in our analysis. 
```{r, results='asis', cap}
out <- all_data %>% group_by(dead, lupus) %>% 
  summarize(Age = round(mean(age), 2),
            Female = paste(round(mean(male=='0')*100,2),'%'),
            `Elix score` = round(mean(elix_score,na.rm=T), 2),
            `On ventilator` = paste(round(100*mean(ventilator=='1'), 2),'%'),
            `On medicare` = paste(round(100*mean(medicare), 2),'%'),
            `On medicaid` = paste(round(100*mean(medicaid),2),'%'),
            `On private insurance` = paste(round(100*mean(private),2),'%'), 
            `On other insurance` = paste(round(100*mean(otherins),2),'%')) %>% 
  ungroup() %>% 
  mutate(dead = ifelse(dead == 1, 'dead', 'alive'),
         lupus = ifelse(lupus == 1, 'sle','non-sle'),
         cats = paste(lupus, dead)) %>% 
  select(-dead, -lupus) %>% select( cats, Age:`On other insurance`)
out2 = data.frame(t(out)[-1,])
names(out2) <- unique(out$cats)
knitr::kable(out2)

```

## Figure 1

```{r, fig.width=7}
load('data/lupuseffect.rda')
blah = oe_overall %>% filter(oe_ratio>0)
bl2 = oe_overall %>% filter(oe_ratio==0)

blah <- rbind(blah, bl2[1:45,])
plt <- ggplot(blah, aes(oe_ratio))+
  geom_histogram(binwidth=0.25)+
  scale_x_continuous('Observed/Expected ratio',breaks=seq(0,10))+
  geom_vline(xintercept=1, linetype=2)+
  ylim(0,50)+
  annotate('text',x=0, y=47,label=sprintf('\u2191'))+
  annotate('text',x=0, y=49, label='N=163', size=3) + 
  ylab('Frequency')
print(plt)
```

## Figure 2

```{r, message=F, warning=F, results='hide', fig.width=7}
death_rate <- all_data %>% group_by(hospid) %>% summarize(rate = mean(dead))
lupus <- all_data %>% group_by(hospid) %>% summarise(n_lupus = sum(lupus))
hosp_data <- hosp_data %>% left_join(death_rate) %>% left_join(lupus) %>% left_join(oe_overall)
dat_for_plot <- hosp_data %>% select(hospid, rate, n_lupus, oe_ratio) 
mr <- median(dat_for_plot$rate)
plt <- ggplot(dat_for_plot, aes(rate, oe_ratio))+
  # geom_hline(yintercept = c(1,2), linetype=c(1,2), size=2, alpha = c(0.5,1)) +
  geom_segment(aes(x = median(rate), xend = median(rate), y=0, yend=8),
               linetype=2)+
  geom_segment(x = 0, xend=.38, y=1,yend=1,
               linetype=1, size=1, color='grey')+
  geom_segment(x = 0, xend=.38, y=2,yend=2,
               linetype=2, size=1.5, alpha=1)+
  geom_point(aes(size=n_lupus)) +
  scale_x_continuous('Death rate', 
                     breaks = c(.1, .2, .3),
                     labels = c('10%','20%','30%')) + 
  scale_y_continuous('O/E ratio for lupus', breaks = c(1,seq(0,10,by  =2))) + 
  scale_size_continuous('# SLE', breaks =c(10,20,40,60))+
  annotate('text',x = c(mr-0.03, mr+0.03, mr), 
                      y = c(9,9,8.3),
           label=c(paste('\u2190','A-'),
                   paste('A+','\u2192'),'Median'), 
           hjust=c(1,0,0), angle=c(0,0,90), size=5)+
  annotate('text', 
           x = c(.4,.4),
           y = c(1.5,2.5),
           label = c(paste('R-',sprintf('\u2192')), paste(sprintf('\u2190'),'R+')),
           angle=-90, vjust = c(.5,.5), hjust=c(0,1), size=5)
ggsave('Fig2.tiff', width=8, height=4, units='in')
print(plt)
```


```{r, fig.width=6, results='hide', eval=FALSE}
hosp_data <- hosp_data %>% mutate(smr_cat = ifelse(oe_ratio >=2, 'relative +','relative -'),
                                  death_cat = ifelse(rate >= median(rate), 'absolute +','absolute -'),
                                  categories = factor(paste(smr_cat, death_cat, sep=', ')))

tree2 <- rpart(categories ~ new_highvolume + new_bedsize+ new_teach + region,
      data = hosp_data, control = rpart.control(minsplit=10) )
rpart.plot(tree2)```


[^1]: Chen, T. and Guestrin, C., 2016, August. Xgboost: A scalable tree boosting system. In Proceedings of the 22nd acm sigkdd international conference on knowledge discovery and data mining (pp. 785-794). ACM.